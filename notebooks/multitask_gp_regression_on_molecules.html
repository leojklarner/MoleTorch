<!DOCTYPE html>

<html class="no-js" data-content_root="../" lang="en">
<head><meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="light dark" name="color-scheme"/><meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="Multitask GP Regression on Molecules" property="og:title"/>
<meta content="website" property="og:type"/>
<meta content="notebooks/multitask_gp_regression_on_molecules.html" property="og:url"/>
<meta content="GAUCHE" property="og:site_name"/>
<meta content="An example notebook for multitask GP regression on a molecular dataset. We use a multioutput GP model, the intrinsic coregionalisation model (ICM) [1] on the Photoswitch Dataset [2] — using a Tanim..." property="og:description"/>
<meta content="1146" property="og:image:width"/>
<meta content="600" property="og:image:height"/>
<meta content="/_images/social_previews/summary_notebooks_multitask_gp_regression_on_molecules_8a715564.png" property="og:image"/>
<meta content="An example notebook for multitask GP regression on a molecular dataset. We use a multioutput GP model, the intrinsic coregionalisation model (ICM) [1] on the..." property="og:image:alt"/>
<meta content="An example notebook for multitask GP regression on a molecular dataset. We use a multioutput GP model, the intrinsic coregionalisation model (ICM) [1] on the Photoswitch Dataset [2] — using a Tanim..." name="description"/>
<meta content="summary_large_image" name="twitter:card"/>
<link href="../genindex.html" rel="index" title="Index"/><link href="../search.html" rel="search" title="Search"/><link href="molecular_preference_learning.html" rel="next" title="Learning an Objective Function through Interaction with a Human Chemist"/><link href="sparse_gp_regression_for_big_molecular_data.html" rel="prev" title="Sparse GP Regression on Molecules"/>
<!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
<title>Multitask GP Regression on Molecules - GAUCHE documentation</title>
<link href="../_static/pygments.css?v=a746c00c" rel="stylesheet" type="text/css"/>
<link href="../_static/styles/furo.css?v=135e06be" rel="stylesheet" type="text/css"/>
<link href="../_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
<link href="../_static/tabs.css?v=4c969af8" rel="stylesheet" type="text/css"/>
<link href="../_static/sphinx-codeautolink.css?v=125d5c1c" rel="stylesheet" type="text/css"/>
<link href="../_static/nbsphinx-code-cells.css" rel="stylesheet" type="text/css"/>
<link href="../_static/styles/furo-extensions.css?v=36a5483c" rel="stylesheet" type="text/css"/>
<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></meta></head>
<body>
<script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<symbol id="svg-toc" viewbox="0 0 24 24">
<title>Contents</title>
<svg fill="currentColor" stroke="currentColor" stroke-width="0" viewbox="0 0 1024 1024">
<path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"></path>
</svg>
</symbol>
<symbol id="svg-menu" viewbox="0 0 24 24">
<title>Menu</title>
<svg class="feather-menu" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<line x1="3" x2="21" y1="12" y2="12"></line>
<line x1="3" x2="21" y1="6" y2="6"></line>
<line x1="3" x2="21" y1="18" y2="18"></line>
</svg>
</symbol>
<symbol id="svg-arrow-right" viewbox="0 0 24 24">
<title>Expand</title>
<svg class="feather-chevron-right" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<polyline points="9 18 15 12 9 6"></polyline>
</svg>
</symbol>
<symbol id="svg-sun" viewbox="0 0 24 24">
<title>Light mode</title>
<svg class="feather-sun" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="5"></circle>
<line x1="12" x2="12" y1="1" y2="3"></line>
<line x1="12" x2="12" y1="21" y2="23"></line>
<line x1="4.22" x2="5.64" y1="4.22" y2="5.64"></line>
<line x1="18.36" x2="19.78" y1="18.36" y2="19.78"></line>
<line x1="1" x2="3" y1="12" y2="12"></line>
<line x1="21" x2="23" y1="12" y2="12"></line>
<line x1="4.22" x2="5.64" y1="19.78" y2="18.36"></line>
<line x1="18.36" x2="19.78" y1="5.64" y2="4.22"></line>
</svg>
</symbol>
<symbol id="svg-moon" viewbox="0 0 24 24">
<title>Dark mode</title>
<svg class="icon-tabler-moon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
<path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
</svg>
</symbol>
<symbol id="svg-sun-half" viewbox="0 0 24 24">
<title>Auto light/dark mode</title>
<svg class="icon-tabler-shadow" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
<circle cx="12" cy="12" r="9"></circle>
<path d="M13 12h5"></path>
<path d="M13 15h4"></path>
<path d="M13 18h1"></path>
<path d="M13 9h4"></path>
<path d="M13 6h1"></path>
</svg>
</symbol>
</svg>
<input class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<input class="sidebar-toggle" id="__toc" name="__toc" type="checkbox"/>
<label class="overlay sidebar-overlay" for="__navigation">
<div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
<div class="visually-hidden">Hide table of contents sidebar</div>
</label>
<div class="page">
<header class="mobile-header">
<div class="header-left">
<label class="nav-overlay-icon" for="__navigation">
<div class="visually-hidden">Toggle site navigation sidebar</div>
<i class="icon"><svg><use href="#svg-menu"></use></svg></i>
</label>
</div>
<div class="header-center">
<a href="../index.html"><div class="brand">GAUCHE  documentation</div></a>
</div>
<div class="header-right">
<div class="theme-toggle-container theme-toggle-header">
<button class="theme-toggle">
<div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
<svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
<svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
<svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
</button>
</div>
<label class="toc-overlay-icon toc-header-icon" for="__toc">
<div class="visually-hidden">Toggle table of contents sidebar</div>
<i class="icon"><svg><use href="#svg-toc"></use></svg></i>
</label>
</div>
</header>
<aside class="sidebar-drawer">
<div class="sidebar-container">
<div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
<span class="sidebar-brand-text">GAUCHE  documentation</span>
</a><form action="../search.html" class="sidebar-search-container" method="get" role="search">
<input aria-label="Search" class="sidebar-search" name="q" placeholder="Search"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="loading_and_featurising_molecules.html">Loading and Featurising Molecular Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="gp_regression_on_molecules.html">GP Regression on Molecules</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayesian_optimisation_over_molecules.html">Bayesian Optimisation Over Molecules</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse_gp_regression_for_big_molecular_data.html">Sparse GP Regression on Molecules</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Multitask GP Regression on Molecules</a></li>
<li class="toctree-l1"><a class="reference internal" href="molecular_preference_learning.html">Learning an Objective Function through Interaction with a Human Chemist</a></li>
<li class="toctree-l1"><a class="reference internal" href="preferential_bayesian_optimisation.html">Preferential Bayesian Optimisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="protein_fitness_prediction_bag_of_amino_acids.html">GP Regression on Protein Sequences: Bag of Amino Acids</a></li>
<li class="toctree-l1"><a class="reference internal" href="protein_fitness_prediction_ssk_gp.html">GP Regression on Protein Sequences: Subsequence String Kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayesian_gnn_on_molecules.html">Bayesian GNNs for Molecular Property Prediction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/kernels.html">gauche.kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/representations.html">gauche.representations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/dataloader.html">gauche.dataloader</a></li>
</ul>
</div>
</div>
</div>
</div>
</aside>
<div class="main">
<div class="content">
<div class="article-container">
<a class="back-to-top muted-link" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
</svg>
<span>Back to top</span>
</a>
<div class="content-icon-container">
<div class="theme-toggle-container theme-toggle-content">
<button class="theme-toggle">
<div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
<svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
<svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
<svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
</button>
</div>
<label class="toc-overlay-icon toc-content-icon" for="__toc">
<div class="visually-hidden">Toggle table of contents sidebar</div>
<i class="icon"><svg><use href="#svg-toc"></use></svg></i>
</label>
</div>
<article role="main">
<section id="Multitask-GP-Regression-on-Molecules">
<h1>Multitask GP Regression on Molecules<a class="headerlink" href="#Multitask-GP-Regression-on-Molecules" title="Link to this heading">#</a></h1>
<p>An example notebook for multitask GP regression on a molecular dataset. We use a multioutput GP model, the intrinsic coregionalisation model (ICM) [1] on the Photoswitch Dataset [2] — using a Tanimoto kernel applied to fragprint representations [2]. The paper and code for the dataset is available here:</p>
<p>Paper: <a class="reference external" href="https://pubs.rsc.org/en/content/articlelanding/2022/sc/d2sc04306h">https://pubs.rsc.org/en/content/articlelanding/2022/sc/d2sc04306h</a></p>
<p>Code: <a class="reference external" href="https://github.com/Ryan-Rhys/The-Photoswitch-Dataset">https://github.com/Ryan-Rhys/The-Photoswitch-Dataset</a></p>
<section id="Multitask-Learning-with-Gaussian-Processes">
<h2>Multitask Learning with Gaussian Processes<a class="headerlink" href="#Multitask-Learning-with-Gaussian-Processes" title="Link to this heading">#</a></h2>
<p>Multitask learning is concerned with using a shared representation to learn several tasks; the idea being that predictive performance on a given task may benefit from the training signals of related tasks. Multioutput Gaussian processes (MOGPs) is the term given to models that perform multitask learning in the Gaussian process framework.</p>
<p>Formally, we seek to carry out Bayesian inference over a stochastic function <span class="math notranslate nohighlight">\(f: \mathbb{R}^D \to \mathbb{R}^P\)</span> where <span class="math notranslate nohighlight">\(P\)</span> is the number of tasks and we have access to observations <span class="math notranslate nohighlight">\(\{(\mathbf{x_{11}}, y_{11}), \dotsc , (\mathbf{x_{1N}}, y_{1N}), \dotsc , (\mathbf{x_{P1}}, y_{P1}), \dotsc , (\mathbf{x_{PN}}, y_{PN})\}\)</span>. For each input, we may only have labels for a subset of the tasks.</p>
<p>To build a MOGP we compute a kernel <span class="math notranslate nohighlight">\(k(\mathbf{x}, \mathbf{x'}) \cdot B[i, j]\)</span> where <span class="math notranslate nohighlight">\(B\)</span> is a positive semidefinite <span class="math notranslate nohighlight">\(P \times P\)</span> matrix , where the <span class="math notranslate nohighlight">\((i, j)\text{th}\)</span> entry of the matrix <span class="math notranslate nohighlight">\(B\)</span> multiplies the covariance of the <span class="math notranslate nohighlight">\(i\)</span>-th function at <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> and the <span class="math notranslate nohighlight">\(j\)</span>-th function at <span class="math notranslate nohighlight">\(\mathbf{x'}\)</span>. <span class="math notranslate nohighlight">\(B\)</span> is often referred to as an index kernel because it indexes the tasks.</p>
<p>Inference proceeds in analogous fashion to vanilla Gaussian processes by substituting the new expression for the kernel into the equations for the predictive mean and variance.</p>
<p>Positive semi-definiteness of <span class="math notranslate nohighlight">\(B\)</span> is guaranteed by parametrising the Cholesky decomposition <span class="math notranslate nohighlight">\(LL^{\top}\)</span> where <span class="math notranslate nohighlight">\(L\)</span>, the Cholesky factor, is a lower triangular matrix and the parameters may be learned alongside the kernel hyperparameters by optimising the marginal likelihood.</p>
<p>An example of what correlated tasks for continuous input spaces might look like is provided below. Data taken from the GPflow tutorial (<a class="reference external" href="https://gpflow.readthedocs.io/en/v1.5.1-docs/notebooks/advanced/coregionalisation.html">https://gpflow.readthedocs.io/en/v1.5.1-docs/notebooks/advanced/coregionalisation.html</a>).</p>
<p align="center"><p><img alt="a6f82fbaa7aa4d12b121c5a64b129d12" class="no-scaled-link" src="notebooks/assets/gpflow_mogp_data.png" style="width: 35%;"/></p>
</p><div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>

<span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/warnings.html#module-warnings" title="warnings"><span class="nn">warnings</span></a>
<a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/warnings.html#warnings.filterwarnings" title="warnings.filterwarnings"><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span></a><span class="p">(</span><span class="s2">"ignore"</span><span class="p">)</span> <span class="c1"># Turn off Graphein warnings</span>

<span class="kn">from</span> <span class="nn">botorch</span> <span class="kn">import</span> <span class="n">fit_gpytorch_model</span>
<span class="kn">import</span> <span class="nn">gpytorch</span>
<span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/index.html#module-numpy" title="numpy"><span class="nn">numpy</span></a> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/classes.html#module-sklearn.model_selection" title="sklearn.model_selection"><span class="nn">sklearn.model_selection</span></a> <span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html#sklearn.model_selection.train_test_split" title="sklearn.model_selection.train_test_split"><span class="n">train_test_split</span></a>
<span class="kn">from</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/classes.html#module-sklearn.metrics" title="sklearn.metrics"><span class="nn">sklearn.metrics</span></a> <span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.r2_score.html#sklearn.metrics.r2_score" title="sklearn.metrics.r2_score"><span class="n">r2_score</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.mean_squared_error.html#sklearn.metrics.mean_squared_error" title="sklearn.metrics.mean_squared_error"><span class="n">mean_squared_error</span></a><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.mean_absolute_error.html#sklearn.metrics.mean_absolute_error" title="sklearn.metrics.mean_absolute_error"><span class="n">mean_absolute_error</span></a>
<span class="kn">import</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/torch.html#module-torch" title="torch"><span class="nn">torch</span></a>

<span class="kn">from</span> <span class="nn">gauche.dataloader</span> <span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../modules/dataloader.html#gauche.dataloader.molprop_loader.MolPropLoader" title="gauche.dataloader.molprop_loader.MolPropLoader"><span class="n">MolPropLoader</span></a>
<span class="kn">from</span> <a class="sphinx-codeautolink-a" href="../modules/dataloader.html#module-gauche.dataloader.data_utils" title="gauche.dataloader.data_utils"><span class="nn">gauche.dataloader.data_utils</span></a> <span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../modules/dataloader.html#gauche.dataloader.data_utils.transform_data" title="gauche.dataloader.data_utils.transform_data"><span class="n">transform_data</span></a>
</pre></div>
</div>
</div>
<p>We define our model. See</p>
<p><a class="reference external" href="https://docs.gpytorch.ai/en/stable/examples/03_Multitask_Exact_GPs/Multitask_GP_Regression.html">https://docs.gpytorch.ai/en/stable/examples/03_Multitask_Exact_GPs/Multitask_GP_Regression.html</a></p>
<p>for a tutorial for the use of the base multioutput GP on non-molecular data!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We define our MOGP model using the Tanimoto kernel</span>

<span class="kn">from</span> <a class="sphinx-codeautolink-a" href="../modules/kernels.html#module-gauche.kernels.fingerprint_kernels.tanimoto_kernel" title="gauche.kernels.fingerprint_kernels.tanimoto_kernel"><span class="nn">gauche.kernels.fingerprint_kernels.tanimoto_kernel</span></a> <span class="kn">import</span> <a class="sphinx-codeautolink-a" href="../modules/kernels.html#gauche.kernels.fingerprint_kernels.tanimoto_kernel.TanimotoKernel" title="gauche.kernels.fingerprint_kernels.tanimoto_kernel.TanimotoKernel"><span class="n">TanimotoKernel</span></a>

<span class="n">num_tasks</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># number of tasks i.e. labels</span>
<span class="n">rank</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># increasing the rank hyperparameter allows the model to learn more expressive</span>
         <span class="c1"># correlations between objectives at the expense of increasing the number of</span>
         <span class="c1"># model hyperparameters and potentially overfitting.</span>

<span class="k">class</span> <span class="nc">MultitaskGPModel</span><span class="p">(</span><span class="n">gpytorch</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ExactGP</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">):</span>
        <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#super" title="super"><span class="nb">super</span></a><span class="p">(</span><span class="n">MultitaskGPModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_module</span> <span class="o">=</span> <span class="n">gpytorch</span><span class="o">.</span><span class="n">means</span><span class="o">.</span><span class="n">ConstantMean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covar_module</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../modules/kernels.html#gauche.kernels.fingerprint_kernels.tanimoto_kernel.TanimotoKernel" title="gauche.kernels.fingerprint_kernels.tanimoto_kernel.TanimotoKernel"><span class="n">TanimotoKernel</span></a><span class="p">()</span>

        <span class="c1"># We learn an IndexKernel for 4 tasks</span>
        <span class="c1"># (so we'll actually learn 4x4=16 tasks with correlations)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_covar_module</span> <span class="o">=</span> <span class="n">gpytorch</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">IndexKernel</span><span class="p">(</span><span class="n">num_tasks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">mean_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_module</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Get input-input covariance</span>
        <span class="n">covar_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covar_module</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># Get task-task covariance</span>
        <span class="n">covar_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_covar_module</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># Multiply the two together to get the covariance we want</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">covar_x</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">covar_i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gpytorch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">mean_x</span><span class="p">,</span> <span class="n">covar</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>We define our experiment parameters. In this case we are reproducing the results of the multioutput GP prediction task from <a class="reference external" href="https://pubs.rsc.org/en/content/articlelanding/2022/sc/d2sc04306h">https://pubs.rsc.org/en/content/articlelanding/2022/sc/d2sc04306h</a> using 20 random splits in the ratio 80/20.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Regression experiment parameters, number of random splits and train/test split size</span>

<span class="n">n_trials</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">test_set_size</span> <span class="o">=</span> <span class="mf">0.2</span>
</pre></div>
</div>
</div>
<p>Load the Photoswitch Dataset via the MolPropLoader class.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the Photoswitch dataset</span>

<a class="sphinx-codeautolink-a" href="../modules/dataloader.html#gauche.dataloader.molprop_loader.MolPropLoader" title="gauche.dataloader.molprop_loader.MolPropLoader"><span class="n">loader</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="../modules/dataloader.html#gauche.dataloader.molprop_loader.MolPropLoader" title="gauche.dataloader.molprop_loader.MolPropLoader"><span class="n">MolPropLoader</span></a><span class="p">()</span>

<span class="c1"># Define a utility function for dataloading</span>

<span class="k">def</span> <span class="nf">load_task_data</span><span class="p">(</span><span class="n">task</span><span class="p">,</span>
                   <span class="n">loader</span><span class="o">=</span><a class="sphinx-codeautolink-a" href="../modules/dataloader.html#gauche.dataloader.molprop_loader.MolPropLoader" title="gauche.dataloader.molprop_loader.MolPropLoader"><span class="n">MolPropLoader</span></a><span class="p">(),</span>
                   <span class="n">path</span><span class="o">=</span><span class="s1">'Photoswitch'</span><span class="p">,</span>
                   <span class="n">representation</span><span class="o">=</span><span class="s1">'ecfp_fragprints'</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load data for a given task.</span>

<span class="sd">    Args:</span>
<span class="sd">        task: str specifying the task to load data for.</span>
<span class="sd">        One of ['Photoswitch', 'Photoswitch_E_n_pi', 'Photoswitch_Z_pi_pi', 'Photoswitch_Z_n_pi']</span>
<span class="sd">        loader: DataLoader object</span>
<span class="sd">        path: str specifying dataset.</span>
<span class="sd">        representation: str specifying representation. One of ['ecfp_fingerprints', 'ecfp_fragprints', 'fragments']</span>

<span class="sd">    Returns:</span>
<span class="sd">        X_task: tensor of features for task</span>
<span class="sd">        y_task: tensor of labels for task</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="n">representation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'ecfp_fragprints'</span><span class="p">,</span> <span class="s1">'ecfp_fingerprints'</span><span class="p">,</span> <span class="s1">'fragments'</span><span class="p">]:</span>
        <span class="k">raise</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="ValueError"><span class="ne">ValueError</span></a><span class="p">(</span><span class="s1">'representation not valid.'</span>
                         <span class="s1">'Please choose one of ecfp_fragprints, ecfp_fingerprints, fragments'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">task</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'Photoswitch'</span><span class="p">,</span> <span class="s1">'Photoswitch_E_n_pi'</span><span class="p">,</span> <span class="s1">'Photoswitch_Z_pi_pi'</span><span class="p">,</span> <span class="s1">'Photoswitch_Z_n_pi'</span><span class="p">]:</span>
        <span class="k">raise</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="ValueError"><span class="ne">ValueError</span></a><span class="p">(</span><span class="s1">'task not valid. Please choose one of Photoswitch,'</span>
                         <span class="s1">'Photoswitch_E_n_pi, Photoswitch_Z_pi_pi, Photoswitch_Z_n_pi'</span><span class="p">)</span>

    <span class="n">loader</span><span class="o">.</span><span class="n">load_benchmark</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Featurise the molecules.</span>
    <span class="c1"># We use the fragprints representations (a concatenation of Morgan fingerprints and RDKit fragment features)</span>

    <span class="n">loader</span><span class="o">.</span><span class="n">featurize</span><span class="p">(</span><span class="n">representation</span><span class="p">)</span>
    <span class="n">X_task</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
    <span class="n">y_task</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">X_task</span><span class="p">,</span> <span class="n">y_task</span>

<span class="c1"># Load features X1-X4 and properties (tasks) y1-y4.</span>

<span class="n">X1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">load_task_data</span><span class="p">(</span><span class="s1">'Photoswitch'</span><span class="p">)</span>
<span class="n">X2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">load_task_data</span><span class="p">(</span><span class="s1">'Photoswitch_E_n_pi'</span><span class="p">)</span>
<span class="n">X3</span><span class="p">,</span> <span class="n">y3</span> <span class="o">=</span> <span class="n">load_task_data</span><span class="p">(</span><span class="s1">'Photoswitch_Z_pi_pi'</span><span class="p">)</span>
<span class="n">X4</span><span class="p">,</span> <span class="n">y4</span> <span class="o">=</span> <span class="n">load_task_data</span><span class="p">(</span><span class="s1">'Photoswitch_Z_n_pi'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Found 13 invalid labels [nan nan nan nan nan nan nan nan nan nan nan nan nan] at indices [41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 158]
To turn validation off, use dataloader.read_csv(..., validate=False).
Found 13 invalid labels [nan nan nan nan nan nan nan nan nan nan nan nan nan] at indices [41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 158]
To turn validation off, use dataloader.read_csv(..., validate=False).
Found 13 invalid labels [nan nan nan nan nan nan nan nan nan nan nan nan nan] at indices [41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 158]
To turn validation off, use dataloader.read_csv(..., validate=False).
Found 13 invalid labels [nan nan nan nan nan nan nan nan nan nan nan nan nan] at indices [41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 158]
To turn validation off, use dataloader.read_csv(..., validate=False).
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">"""Helper function for model evaluation.</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">prevent_test_leakage</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function to prevent test leakage in train/test splits for multitask learning, for example,</span>
<span class="sd">    for test data point x_i, do not provide the model with auxiliary tasks P2-P4 when predicting P1.</span>

<span class="sd">    param: x1, x2, x3: input molecules for other tasks</span>
<span class="sd">    param: y1, y2, y3: labels for other tasks</span>
<span class="sd">    param: X_test: the test molecules</span>
<span class="sd">    """</span>

    <span class="n">other_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">]</span>
    <span class="n">other_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/stdtypes.html#range" title="range"><span class="nb">range</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#len" title="len"><span class="nb">len</span></a><span class="p">(</span><span class="n">other_tasks</span><span class="p">)):</span>
        <span class="n">indices_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/stdtypes.html#range" title="range"><span class="nb">range</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#len" title="len"><span class="nb">len</span></a><span class="p">(</span><span class="n">other_tasks</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">other_mol</span> <span class="o">=</span> <span class="n">other_tasks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.any.html#numpy.any" title="numpy.any"><span class="n">np</span><span class="o">.</span><span class="n">any</span></a><span class="p">([</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.array_equal.html#numpy.array_equal" title="numpy.array_equal"><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span></a><span class="p">(</span><span class="n">other_mol</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">X_test</span><span class="p">])</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">indices_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">indices_to_delete</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices_to_delete</span><span class="p">:</span>
            <span class="n">other_tasks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.delete.html#numpy.delete" title="numpy.delete"><span class="n">np</span><span class="o">.</span><span class="n">delete</span></a><span class="p">(</span><span class="n">other_tasks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">other_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.delete.html#numpy.delete" title="numpy.delete"><span class="n">np</span><span class="o">.</span><span class="n">delete</span></a><span class="p">(</span><span class="n">other_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span> <span class="o">=</span> <span class="n">other_tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">other_tasks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">other_tasks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span> <span class="o">=</span> <span class="n">other_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">other_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">other_labels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span>

<span class="c1"># Experiment parameters, train/test split and task to run prediction for</span>
<span class="n">test_set_size</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">task</span> <span class="o">=</span> <span class="s1">'e_iso_pi'</span>

<span class="n">r2_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rmse_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mae_list</span> <span class="o">=</span> <span class="p">[]</span>

<a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#print" title="print"><span class="nb">print</span></a><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Beginning training loop...'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/stdtypes.html#range" title="range"><span class="nb">range</span></a><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">):</span>

    <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#print" title="print"><span class="nb">print</span></a><span class="p">(</span><span class="sa">f</span><span class="s1">'Starting trial </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s1">'e_iso_pi'</span><span class="p">:</span>
        <span class="n">X_task</span> <span class="o">=</span> <span class="n">X1</span>
        <span class="n">y_task</span> <span class="o">=</span> <span class="n">y1</span>
    <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s1">'z_iso_pi'</span><span class="p">:</span>
        <span class="n">X_task</span> <span class="o">=</span> <span class="n">X2</span>
        <span class="n">y_task</span> <span class="o">=</span> <span class="n">y2</span>
    <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s1">'e_iso_n'</span><span class="p">:</span>
        <span class="n">X_task</span> <span class="o">=</span> <span class="n">X3</span>
        <span class="n">y_task</span> <span class="o">=</span> <span class="n">y3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X_task</span> <span class="o">=</span> <span class="n">X4</span>
        <span class="n">y_task</span> <span class="o">=</span> <span class="n">y4</span>

    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html#sklearn.model_selection.train_test_split" title="sklearn.model_selection.train_test_split"><span class="n">train_test_split</span></a><span class="p">(</span><span class="n">X_task</span><span class="p">,</span> <span class="n">y_task</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_set_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># Partition the training data into tasks (most difficult part of training a multioutput GP!)</span>

    <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s1">'e_iso_pi'</span><span class="p">:</span>

        <span class="c1"># Modify the x-values for the other tasks to exclude X_test</span>
        <span class="n">X2_new</span><span class="p">,</span> <span class="n">X3_new</span><span class="p">,</span> <span class="n">X4_new</span><span class="p">,</span> <span class="n">y2_new</span><span class="p">,</span> <span class="n">y3_new</span><span class="p">,</span> <span class="n">y4_new</span> <span class="o">=</span> \
            <span class="n">prevent_test_leakage</span><span class="p">(</span><span class="n">X2</span><span class="p">,</span> <span class="n">X3</span><span class="p">,</span> <span class="n">X4</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">y4</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>

        <span class="n">train_i_task1</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">train_i_task2</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X2_new</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">train_i_task3</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X3_new</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">train_i_task4</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X4_new</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">full_train_x</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.cat.html#torch.cat" title="torch.cat"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a><span class="p">([</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X2_new</span><span class="p">,</span> <span class="n">X3_new</span><span class="p">,</span> <span class="n">X4_new</span><span class="p">])</span>
        <span class="n">full_train_y</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.cat.html#torch.cat" title="torch.cat"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a><span class="p">([</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y2_new</span><span class="p">,</span> <span class="n">y3_new</span><span class="p">,</span> <span class="n">y4_new</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">test_i_task</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s1">'e_iso_n'</span><span class="p">:</span>
        <span class="n">X1</span><span class="p">,</span> <span class="n">X3</span><span class="p">,</span> <span class="n">X4</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">y4</span> <span class="o">=</span> \
            <span class="n">prevent_test_leakage</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">X3</span><span class="p">,</span> <span class="n">X4</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">y4</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>

        <span class="n">train_i_task1</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">train_i_task2</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">train_i_task3</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">train_i_task4</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X4</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">full_train_x</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.cat.html#torch.cat" title="torch.cat"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a><span class="p">([</span><span class="n">X1</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X3</span><span class="p">,</span> <span class="n">X4</span><span class="p">])</span>
        <span class="n">full_train_y</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.cat.html#torch.cat" title="torch.cat"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a><span class="p">([</span><span class="n">y1</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">y4</span><span class="p">])</span>

        <span class="n">test_i_task</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s1">'z_iso_pi'</span><span class="p">:</span>
        <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">X4</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y4</span> <span class="o">=</span> \
            <span class="n">prevent_test_leakage</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">X4</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y4</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>

        <span class="n">train_i_task1</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">train_i_task2</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">train_i_task3</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">train_i_task4</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X4</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">full_train_x</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.cat.html#torch.cat" title="torch.cat"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a><span class="p">([</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X4</span><span class="p">])</span>
        <span class="n">full_train_y</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.cat.html#torch.cat" title="torch.cat"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a><span class="p">([</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y4</span><span class="p">])</span>

        <span class="n">test_i_task</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">X3</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span> <span class="o">=</span> \
            <span class="n">prevent_test_leakage</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">X3</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>

        <span class="n">train_i_task1</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">train_i_task2</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">train_i_task3</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">train_i_task4</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">full_train_x</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.cat.html#torch.cat" title="torch.cat"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a><span class="p">([</span><span class="n">X1</span><span class="p">,</span> <span class="n">X2</span><span class="p">,</span> <span class="n">X3</span><span class="p">,</span> <span class="n">X_train</span><span class="p">])</span>
        <span class="n">full_train_y</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.cat.html#torch.cat" title="torch.cat"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a><span class="p">([</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">y_train</span><span class="p">])</span>

        <span class="n">test_i_task</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.full.html#torch.full" title="torch.full"><span class="n">torch</span><span class="o">.</span><span class="n">full</span></a><span class="p">((</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>


    <span class="n">full_train_i</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.cat.html#torch.cat" title="torch.cat"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a><span class="p">([</span><span class="n">train_i_task1</span><span class="p">,</span> <span class="n">train_i_task2</span><span class="p">,</span> <span class="n">train_i_task3</span><span class="p">,</span> <span class="n">train_i_task4</span><span class="p">])</span>

    <span class="c1"># Gaussian likelihood</span>
    <span class="n">likelihood</span> <span class="o">=</span> <span class="n">gpytorch</span><span class="o">.</span><span class="n">likelihoods</span><span class="o">.</span><span class="n">GaussianLikelihood</span><span class="p">()</span>

    <span class="c1"># Here we have two items that we're passing in as train_inputs</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">MultitaskGPModel</span><span class="p">((</span><span class="n">full_train_x</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">full_train_i</span><span class="o">.</span><span class="n">float</span><span class="p">()),</span> <span class="n">full_train_y</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">likelihood</span><span class="p">)</span>

    <span class="c1"># "Loss" for GPs - the marginal log likelihood</span>
    <span class="n">mll</span> <span class="o">=</span> <span class="n">gpytorch</span><span class="o">.</span><span class="n">mlls</span><span class="o">.</span><span class="n">ExactMarginalLogLikelihood</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

    <span class="c1"># Use the BoTorch utility for fitting GPs in order to use the LBFGS-B optimiser (recommended)</span>
    <span class="c1"># Set the jitter level larger than the default for the MOGP</span>
    <span class="k">with</span> <span class="n">gpytorch</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cholesky_jitter</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">):</span>
        <span class="n">fit_gpytorch_model</span><span class="p">(</span><span class="n">mll</span><span class="p">)</span>

    <span class="c1"># Get into evaluation (predictive posterior) mode</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">likelihood</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="c1"># The gpytorch.settings.fast_pred_var flag activates LOVE (for fast variances)</span>
    <span class="c1"># See https://arxiv.org/abs/1803.06058</span>
    <span class="k">with</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/generated/torch.no_grad.html#torch.no_grad" title="torch.autograd.grad_mode.no_grad"><span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span></a><span class="p">(),</span> <span class="n">gpytorch</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">fast_pred_var</span><span class="p">():</span>
        <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/distributions.html#torch.distributions.distribution.Distribution" title="torch.distributions.distribution.Distribution"><span class="n">observed_pred_y</span></a> <span class="o">=</span> <span class="n">likelihood</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">test_i_task</span><span class="o">.</span><span class="n">float</span><span class="p">()))</span>

    <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/distributions.html#torch.distributions.distribution.Distribution.mean" title="torch.distributions.distribution.Distribution.mean"><span class="n">y_pred</span></a> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/distributions.html#torch.distributions.distribution.Distribution.mean" title="torch.distributions.distribution.Distribution.mean"><span class="n">observed_pred_y</span><span class="o">.</span><span class="n">mean</span></a>

    <span class="c1"># Compute R^2, RMSE and MAE on Test set</span>
    <span class="n">score</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.r2_score.html#sklearn.metrics.r2_score" title="sklearn.metrics.r2_score"><span class="n">r2_score</span></a><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/distributions.html#torch.distributions.distribution.Distribution.mean" title="torch.distributions.distribution.Distribution.mean"><span class="n">y_pred</span></a><span class="p">)</span>
    <span class="n">rmse</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.mean_squared_error.html#sklearn.metrics.mean_squared_error" title="sklearn.metrics.mean_squared_error"><span class="n">mean_squared_error</span></a><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/distributions.html#torch.distributions.distribution.Distribution.mean" title="torch.distributions.distribution.Distribution.mean"><span class="n">y_pred</span></a><span class="p">))</span>
    <span class="n">mae</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.mean_absolute_error.html#sklearn.metrics.mean_absolute_error" title="sklearn.metrics.mean_absolute_error"><span class="n">mean_absolute_error</span></a><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <a class="sphinx-codeautolink-a" href="https://pytorch.org/docs/master/distributions.html#torch.distributions.distribution.Distribution.mean" title="torch.distributions.distribution.Distribution.mean"><span class="n">y_pred</span></a><span class="p">)</span>

    <a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#print" title="print"><span class="nb">print</span></a><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>

    <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
    <span class="n">mae_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mae</span><span class="p">)</span>

<span class="n">r2_list</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span>
<span class="n">rmse_list</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span>
<span class="n">mae_list</span> <span class="o">=</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array"><span class="n">np</span><span class="o">.</span><span class="n">array</span></a><span class="p">(</span><span class="n">mae_list</span><span class="p">)</span>

<a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#print" title="print"><span class="nb">print</span></a><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">mean R^2: </span><span class="si">{:.4f}</span><span class="s2"> +- </span><span class="si">{:.4f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.mean.html#numpy.mean" title="numpy.mean"><span class="n">np</span><span class="o">.</span><span class="n">mean</span></a><span class="p">(</span><span class="n">r2_list</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.std.html#numpy.std" title="numpy.std"><span class="n">np</span><span class="o">.</span><span class="n">std</span></a><span class="p">(</span><span class="n">r2_list</span><span class="p">)</span><span class="o">/</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#len" title="len"><span class="nb">len</span></a><span class="p">(</span><span class="n">r2_list</span><span class="p">))))</span>
<a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#print" title="print"><span class="nb">print</span></a><span class="p">(</span><span class="s2">"mean RMSE: </span><span class="si">{:.4f}</span><span class="s2"> +- </span><span class="si">{:.4f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.mean.html#numpy.mean" title="numpy.mean"><span class="n">np</span><span class="o">.</span><span class="n">mean</span></a><span class="p">(</span><span class="n">rmse_list</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.std.html#numpy.std" title="numpy.std"><span class="n">np</span><span class="o">.</span><span class="n">std</span></a><span class="p">(</span><span class="n">rmse_list</span><span class="p">)</span><span class="o">/</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#len" title="len"><span class="nb">len</span></a><span class="p">(</span><span class="n">rmse_list</span><span class="p">))))</span>
<a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#print" title="print"><span class="nb">print</span></a><span class="p">(</span><span class="s2">"mean MAE: </span><span class="si">{:.4f}</span><span class="s2"> +- </span><span class="si">{:.4f}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.mean.html#numpy.mean" title="numpy.mean"><span class="n">np</span><span class="o">.</span><span class="n">mean</span></a><span class="p">(</span><span class="n">mae_list</span><span class="p">),</span> <a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.std.html#numpy.std" title="numpy.std"><span class="n">np</span><span class="o">.</span><span class="n">std</span></a><span class="p">(</span><span class="n">mae_list</span><span class="p">)</span><span class="o">/</span><a class="sphinx-codeautolink-a" href="https://numpy.org/doc/stable/reference/generated/numpy.sqrt.html#numpy.sqrt" title="numpy.sqrt"><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span></a><span class="p">(</span><a class="sphinx-codeautolink-a" href="https://docs.python.org/3/library/functions.html#len" title="len"><span class="nb">len</span></a><span class="p">(</span><span class="n">mae_list</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Beginning training loop...
Starting trial 0
19.47147948595366
Starting trial 1
23.791256668510048
Starting trial 2
26.206456838126353
Starting trial 3
20.030068524271805
Starting trial 4
32.67818405073743
Starting trial 5
23.453557811764345
Starting trial 6
20.75033301782167
Starting trial 7
23.209958101999543
Starting trial 8
24.654899652465076
Starting trial 9
17.65168764479574
Starting trial 10
23.086582644605222
Starting trial 11
16.02576800479441
Starting trial 12
24.76230610058969
Starting trial 13
18.59783949898034
Starting trial 14
23.796203872804114
Starting trial 15
18.30003157481471
Starting trial 16
22.394982557795256
Starting trial 17
23.632087011071746
Starting trial 18
23.739771849691213
Starting trial 19
</pre></div></div>
</div>
<p>Multitask learning is especially powerful when there are correlations between different tasks as in the case of photoswitch transition wavelengths. Additionally, when seeking to predict the properties of a molecule for which correlated task labels are available, the multioutput Gaussian process can leverage this information to inform its predictions. For more on multitask learning on molecules cf Ramsundar et al. [3]. For more on multioutput Gaussian processes see [4].</p>
</section>
<section id="References">
<h2>References<a class="headerlink" href="#References" title="Link to this heading">#</a></h2>
<p>[1] Bonilla, E.V., Chai, K. and Williams, C., <a class="reference external" href="https://proceedings.neurips.cc/paper/2007/hash/66368270ffd51418ec58bd793f2d9b1b-Abstract.html">Multi-task Gaussian process prediction</a>. Advances in Neural Information Processing Systems, 20, 2007.</p>
<p>[2] Griffiths, R.R., Greenfield, J.L., Thawani, A.R., Jamasb, A.R., Moss, H.B., Bourached, A., Jones, P., McCorkindale, W., Aldrick, A.A. and Fuchter, M.J., 2022. <a class="reference external" href="https://pubs.rsc.org/en/content/articlehtml/2022/sc/d2sc04306h">Data-driven discovery of molecular photoswitches with multioutput Gaussian processes</a>. Chemical Science.</p>
<p>[3] Ramsundar, B., Kearnes, S., Riley, P., Webster, D., Konerding, D. and Pande, V., 2015. <a class="reference external" href="https://arxiv.org/abs/1502.02072">Massively multitask networks for drug discovery</a>. arXiv preprint arXiv:1502.02072.</p>
<p>[4] <a class="reference external" href="https://invenia.github.io/blog/2021/02/19/OILMM-pt1/">Gaussian Processes: from one to many outputs</a>, Invenia Blog.</p>
</section>
</section>
</article>
</div>
<footer>
<div class="related-pages">
<a class="next-page" href="molecular_preference_learning.html">
<div class="page-info">
<div class="context">
<span>Next</span>
</div>
<div class="title">Learning an Objective Function through Interaction with a Human Chemist</div>
</div>
<svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
</a>
<a class="prev-page" href="sparse_gp_regression_for_big_molecular_data.html">
<svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
<div class="page-info">
<div class="context">
<span>Previous</span>
</div>
<div class="title">Sparse GP Regression on Molecules</div>
</div>
</a>
</div>
<div class="bottom-of-page">
<div class="left-details">
<div class="copyright">
                Copyright © 2022, Ryan Rhys-Griffiths
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
</div>
<div class="right-details">
</div>
</div>
</footer>
</div>
<aside class="toc-drawer">
<div class="toc-sticky toc-scroll">
<div class="toc-title-container">
<span class="toc-title">
            On this page
          </span>
</div>
<div class="toc-tree-container">
<div class="toc-tree">
<ul>
<li><a class="reference internal" href="#">Multitask GP Regression on Molecules</a><ul>
<li><a class="reference internal" href="#Multitask-Learning-with-Gaussian-Processes">Multitask Learning with Gaussian Processes</a></li>
<li><a class="reference internal" href="#References">References</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</aside>
</div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
<script src="../_static/doctools.js?v=888ff710"></script>
<script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../_static/scripts/furo.js?v=32e29ea5"></script>
<script src="../_static/clipboard.min.js?v=a7894cd8"></script>
<script src="../_static/copybutton.js?v=f281be69"></script>
<script src="../_static/tabs.js?v=3ee01567"></script>
<script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>